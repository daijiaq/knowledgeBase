# 知识库文档路由鉴权功能

## 功能概述

本功能为知识库系统实现了文档访问权限控制，确保用户只能访问当前知识库下存在的文档，防止恶意用户通过修改 URL 访问未授权的文档。

## 主要特性

### 🔒 权限控制

- **路由拦截**: 对访问路径 `/knowledgeBase/{knowledgeBaseId}/{documentId}` 进行权限验证
- **安全验证**: 调用后端接口获取知识库下所有文档 ID，验证用户访问的文档是否属于当前知识库
- **访问控制**: knowledgeBaseId 不允许用户随意修改，确保跨知识库的访问安全

### ⚡ 性能优化

- **智能缓存**: 文档 ID 列表缓存 5 分钟，避免重复 API 请求
- **防抖处理**: 用户频繁修改 URL 时，300ms 内的重复请求会被防抖处理
- **缓存同步**: 创建/删除文档后自动清除相关缓存，确保数据一致性

### 🎯 用户体验

#### 合法访问时：

- ✅ 正常跳转到目标文档页面
- ✅ 渲染文档的具体内容（文本、图片、富媒体等）
- ✅ 侧边栏自动高亮当前文档
- ✅ 更新文档列表和导航状态

#### 非法访问时：

- ❌ 页面保持不变，不会发生跳转
- ❌ 弹出友好的错误提示："该文档不属于本知识库"
- ❌ 其他内容和状态完全保持不变
- ❌ 不会破坏用户当前的浏览状态

### 🛡️ 安全策略

#### 降级处理

- **网络异常**: 当 API 请求失败时，默认拒绝访问并提示网络错误
- **参数异常**: 无效的 knowledgeBaseId 或 documentId 会重定向到知识库主页
- **权限不足**: 温和提示用户权限不足，不暴露敏感信息

#### 错误处理

- **接口失败**: 自动降级到安全策略，拒绝访问
- **路由错误**: 捕获路由跳转异常，避免应用崩溃
- **状态同步**: 确保前端状态与后端权限保持一致

## 技术实现

### 核心文件

1. **`src/utils/route-guard.ts`** - 路由守卫核心逻辑

   - 缓存管理
   - 权限验证
   - 防抖处理

2. **`src/router/index.ts`** - 路由配置

   - beforeEnter 守卫注册

3. **`src/pages/document.vue`** - 文档页面状态管理
   - 路由参数监听
   - 状态同步
   - 缓存清除

### 关键 API

- `getKBsAllDocumentIdsApi(knowledgeBaseId)` - 获取知识库下所有文档 ID
- `clearDocumentIdsCache(knowledgeBaseId)` - 清除指定知识库缓存
- `updateDocumentIdsCache(knowledgeBaseId, documentIds)` - 手动更新缓存

### 状态管理

- `currentDocId` - 当前选中文档 ID（控制侧边栏高亮）
- `selectDocId` - 显示的文档 ID（控制编辑器渲染）
- `currentDocType` - 当前选中类型（document/folder）

## 使用场景

### 正常使用流程

1. 用户从侧边栏点击文档
2. 路由守卫验证权限
3. 验证通过，跳转到文档页面
4. 侧边栏高亮当前文档
5. 编辑器渲染文档内容

### 恶意访问阻止

1. 用户手动修改 URL 中的 documentId
2. 路由守卫验证权限
3. 验证失败，阻止跳转
4. 显示错误提示
5. 页面状态保持不变

### 缓存优化场景

1. 用户在同一知识库内频繁切换文档
2. 首次验证时请求 API 并缓存结果
3. 后续验证直接使用缓存，提升响应速度
4. 缓存 5 分钟后自动过期

## 配置说明

- **缓存时间**: 5 分钟（300000ms）
- **防抖延迟**: 300ms
- **错误重试**: 不自动重试，降级到安全策略

## 注意事项

1. **性能考虑**: 缓存机制可能导致新创建的文档在短时间内无法访问，因此在创建/删除文档后会主动清除缓存
2. **网络依赖**: 权限验证依赖网络请求，网络异常时会拒绝访问
3. **状态同步**: 前端路由状态与后端权限数据需要保持同步
4. **用户体验**: 非法访问时不改变页面状态，避免用户困惑
